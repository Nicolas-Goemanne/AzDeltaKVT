@page "/position/edit"
@using Microsoft.AspNetCore.WebUtilities
@using AzDeltaKVT.UI.Services
@using AzDeltaKVT.Dto.Results
@using AzDeltaKVT.Dto.Requests
@using AzDektaKVT.Model
@using System.Text.Json
@inject ApiService Api
@inject NavigationManager Navigation

<PageTitle>@(isEdit ? "Edit Position" : "Add Position")</PageTitle>

<div class="container py-4">
    <h1 class="h3 text-main mb-4">
        <strong>@(isEdit ? "Edit Position" : "Add Position")</strong>
    </h1>

    <div class="row g-3">
        <!-- NM Number -->
        <div class="col-md-6">
            <label class="form-label fw-semibold text-main">NM Number:</label>
            <input type="text" @bind="nmNumber" class="form-control bg-light" disabled />
        </div>

        <!-- Chromosome -->
        <div class="col-md-6">
            <label class="form-label fw-semibold text-main">Chromosome:</label>
            <input type="text" @bind="chromosome" class="form-control bg-light" disabled />
        </div>

        <!-- Position -->
        <div class="col-md-4">
            <label class="form-label fw-semibold text-main">Position:</label>
            <input type="text" @bind="position" class="form-control bg-light" disabled="@isEdit" />
            @if (isEdit)
            {
                <small class="text-muted">INSERT ONLY</small>
            }
        </div>

        <!-- Reference -->
        <div class="col-md-4">
            <label class="form-label fw-semibold text-main">Reference:</label>
            <input type="text" @bind="reference" class="form-control" />
        </div>

        <!-- Alternative -->
        <div class="col-md-4">
            <label class="form-label fw-semibold text-main">Alternative:</label>
            <input type="text" @bind="alternative" class="form-control" />
        </div>

        <!-- Biological Effect -->
        <div class="col-md-6">
            <label class="form-label fw-semibold text-main">Biological Effect:</label>
            <input type="text" @bind="biologicalEffect" class="form-control" />
        </div>

        <!-- Classification -->
        <div class="col-md-6">
            <label class="form-label fw-semibold text-main">Classification:</label>
            <input type="text" @bind="classification" class="form-control" />
        </div>
    </div>

    <div class="d-flex gap-3 mt-4">
        <button class="btn btn-main fw-bold" @onclick="HandleSave">SAVE</button>
        @if (isEdit)
        {
            <button class="btn btn-danger fw-bold">REMOVE</button>
        }
    </div>

</div>

@code {
    private string nmNumber = string.Empty;
    private string chromosome = string.Empty;
    private string position = string.Empty;
    private string reference = string.Empty;
    private string alternative = string.Empty;
    private string biologicalEffect = string.Empty;
    private string classification = string.Empty;
	private string variantId = string.Empty; 

    private bool isEdit = false;


    protected override async Task OnInitializedAsync()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        if (queryParams.TryGetValue("nm", out var nm))
        {
            nmNumber = nm;
        }

        if (queryParams.TryGetValue("chromosome", out var chr))
        {
            chromosome = chr;
        }

        if (queryParams.TryGetValue("variantId", out var var))
        {
            variantId = var;
            isEdit = true;
            await GetPositionInfo(); // Hier roep je de functie aan
        }
    }


    private async Task GetPositionInfo()
    {
        if (int.TryParse(variantId, out int variantIdInt))
        {
            var positionInfo = await Api.GetPositionByVariantId(variantIdInt);

            if (positionInfo != null)
            {
                chromosome = positionInfo.Variant.Chromosome;
                position = positionInfo.Variant.Position.ToString();
                reference = positionInfo.Variant.Reference;
                alternative = positionInfo.Variant.Alternative;
                biologicalEffect = positionInfo.BiologicalEffect;
                classification = positionInfo.Classification;
                nmNumber = positionInfo.NmId;
            }
        }
        else
        {
            // Optioneel: Log foutmelding of behandel het geval dat variantId geen geldig getal is
            Console.WriteLine($"Ongeldige variantId: {variantId}");
        }
    }



    private async Task HandleSave()
    {
        var geneVariantRequest = new GeneVariantRequest
            {
                NmId = nmNumber,
                VariantId = 0,
                Variant = new Variant
                {
                    VariantId = 0,
                    Chromosome = chromosome,
                    Position = int.TryParse(position, out var posVal) ? posVal : 0,
                    Reference = reference,
                    Alternative = alternative,
                    UserInfo = "standarduser" // ✅ Toegevoegd
                },
                BiologicalEffect = biologicalEffect,
                Classification = classification,
                UserInfo = "standarduser" // ✅ Toegevoegd
            };

        if (isEdit)
        {
            await Api.UpdatePosition(geneVariantRequest);
        }
        else
        {
            await Api.CreatePosition(geneVariantRequest);
        }

        Navigation.NavigateTo("/");
    }



}

